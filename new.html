<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewYorkBuy.com - Public Equity Screening Tool</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #1C4E36;
            --secondary: #E8F5E9;
            --accent: #4CAF50;
            --text: #333;
            --light-bg: #f9f9f9;
            --border: #ddd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            color: var(--text);
            background-color: var(--light-bg);
            line-height: 1.6;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 10px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 2rem;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: var(--secondary);
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .page-title {
            margin-bottom: 1.5rem;
            color: var(--primary);
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid var(--accent);
        }
        
        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .stat-card p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .filter-title {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .filter-title i {
            margin-right: 0.5rem;
            color: var(--primary);
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .filter-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #153D2B;
        }
        
        .btn-secondary {
            background-color: #eee;
            color: #666;
        }
        
        .btn-secondary:hover {
            background-color: #ddd;
        }
        
        .stocks-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        th:hover {
            background-color: #153D2B;
        }
        
        th i {
            margin-left: 0.5rem;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: var(--secondary);
        }
        
        .ticker {
            font-weight: 600;
            color: var(--primary);
        }
        
        .exchange {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background-color: #e3f2fd;
            color: #0d47a1;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .nyse {
            background-color: #e8f5e9;
            color: #1b5e20;
        }
        
        .nasdaq {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        
        .price, .pe, .high, .low, .cap {
            font-weight: 500;
            text-align: right;
        }
        
        .cap {
            white-space: nowrap;
        }
        
        .ratio {
            font-weight: 600;
            text-align: right;
        }
        
        .ratio.good {
            color: #2e7d32;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }
        
        .pagination button {
            margin: 0 0.25rem;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pagination button.active {
            background-color: var(--primary);
            color: white;
        }
        
        footer {
            background-color: var(--primary);
            color: white;
            padding: 2rem 0;
            margin-top: 2rem;
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .footer-section {
            flex: 1;
            min-width: 200px;
            margin-bottom: 1.5rem;
        }
        
        .footer-section h3 {
            margin-bottom: 1rem;
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .footer-section h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 2px;
            background-color: var(--accent);
        }
        
        .footer-section ul {
            list-style: none;
        }
        
        .footer-section ul li {
            margin-bottom: 0.5rem;
        }
        
        .footer-section ul li a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-section ul li a:hover {
            color: white;
        }
        
        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .social-links a:hover {
            background-color: var(--accent);
        }
        
        .copyright {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: #aaa;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin-top: 1rem;
                justify-content: center;
            }
            
            nav ul li {
                margin: 0 0.5rem;
            }
            
            .filters {
                padding: 1rem;
            }
            
            .filter-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .stocks-table {
                overflow-x: auto;
            }
            
            .footer-section {
                flex: 100%;
                text-align: center;
            }
            
            .footer-section h3::after {
                left: 50%;
                transform: translateX(-50%);
            }
            
            .social-links {
                justify-content: center;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(28, 78, 54, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span>NewYorkBuy.com</span>
                </div>
                <nav>
                    <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="#" class="active">Public Equity</a></li>
                        <li><a href="#">Private Equity</a></li>
                        <li><a href="#">Research</a></li>
                        <li><a href="#">About</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <h1 class="page-title">Blue Chip Stock Screener</h1>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <h3 id="totalStocks">0</h3>
                    <p>Total Stocks</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgPE">0.00</h3>
                    <p>Average P/E Ratio</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgRatio">0.00%</h3>
                    <p>Avg Price/52w Low Ratio</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalMarketCap">$0B</h3>
                    <p>Total Market Cap</p>
                </div>
            </div>
            
            <div class="filters">
                <div class="filter-title">
                    <i class="fas fa-filter"></i>
                    <h2>Filter Stocks</h2>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="exchange">Exchange</label>
                        <select id="exchange">
                            <option value="all">All Exchanges</option>
                            <option value="NYSE">NYSE</option>
                            <option value="NASDAQ">NASDAQ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="min-pe">Min P/E Ratio</label>
                        <input type="number" id="min-pe" placeholder="Min P/E" min="0" step="0.1">
                    </div>
                    <div class="filter-group">
                        <label for="max-pe">Max P/E Ratio</label>
                        <input type="number" id="max-pe" placeholder="Max P/E" min="0" step="0.1">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="min-price">Min Price ($)</label>
                        <input type="number" id="min-price" placeholder="Min Price" min="0" step="0.01">
                    </div>
                    <div class="filter-group">
                        <label for="max-price">Max Price ($)</label>
                        <input type="number" id="max-price" placeholder="Max Price" min="0" step="0.01">
                    </div>
                    <div class="filter-group">
                        <label for="search">Search by Ticker/Name</label>
                        <input type="text" id="search" placeholder="E.g., AAPL, Apple...">
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="btn-secondary" id="reset-filters">Reset Filters</button>
                    <button class="btn-primary" id="apply-filters">Apply Filters</button>
                </div>
            </div>
            
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading stock data...</p>
            </div>

            <div class="stocks-table">
                <table>
                    <thead>
                        <tr>
                            <th data-sort="exchange">Exchange <i class="fas fa-sort"></i></th>
                            <th data-sort="ticker">Ticker <i class="fas fa-sort"></i></th>
                            <th data-sort="name">Company Name <i class="fas fa-sort"></i></th>
                            <th data-sort="price">Price ($) <i class="fas fa-sort"></i></th>
                            <th data-sort="pe">P/E Ratio <i class="fas fa-sort"></i></th>
                            <th data-sort="high52">52w High <i class="fas fa-sort"></i></th>
                            <th data-sort="low52">52w Low <i class="fas fa-sort"></i></th>
                            <th data-sort="marketcap">Market Cap <i class="fas fa-sort"></i></th>
                            <th data-sort="ratio">Price/52w Low <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="stocks-data">
                        <!-- Stock data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination will be generated here -->
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>About NewYorkBuy</h3>
                    <p>NewYorkBuy.com is dedicated to providing investors with valuable insights on public and private equity opportunities.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="#">Public Equity</a></li>
                        <li><a href="#">Private Equity</a></li>
                        <li><a href="#">Research Reports</a></li>
                        <li><a href="#">Investment Strategies</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="#">Market Analysis</a></li>
                        <li><a href="#">Investment Glossary</a></li>
                        <li><a href="#">Economic Calendar</a></li>
                        <li><a href="#">Investor Education</a></li>
                        <li><a href="#">Research Tools</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <ul>
                        <li><i class="fas fa-map-marker-alt"></i> 123 Wall Street, New York, NY</li>
                        <li><i class="fas fa-phone"></i> (212) 555-1234</li>
                        <li><i class="fas fa-envelope"></i> info@newyorkbuy.com</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 NewYorkBuy.com. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Google Sheets published data URL and settings
        // We need to use a different approach to avoid CORS issues
        const SHEET_ID = '2PACX-1vSx8aQ7JKVPFfgTdwwTImfgEzqGh74mUm8EaVts2WUqLbnfKSGZO8HLUpYp5OfzlJC05lqDN-8QyzFe';
        const SHEET_NAME = 'Table1';
        
        // Global variables
        let allStocks = [];
        let filteredStocks = [];
        let currentSort = { column: null, direction: 'asc' };
        let currentPage = 1;
        const rowsPerPage = 10;
        
        // Load stock data when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Load the data from Google Sheets
            loadStockData();
            
            // Set up event listeners
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
            document.getElementById('search').addEventListener('input', quickSearch);
            
            // Set up sorting
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-sort');
                    sortData(column);
                });
            });
        });
        
        // Load stock data from Google Sheets
        async function loadStockData() {
            showLoading(true);
            
            try {
                // Try to fetch data from Google Sheets
                try {
                    allStocks = await fetchGoogleSheetsData();
                    console.log('Successfully loaded data from Google Sheets');
                } catch (fetchError) {
                    console.warn('Failed to fetch from Google Sheets, using backup data:', fetchError);
                    
                console.log('Successfully loaded sample data');
                    
                // Use the sample data from the screenshot as our reliable data source
                const stockData = [
                    { exchange: 'NYSE', ticker: 'DELL', name: 'DELL TECHNOLOGIES INC CLASS C', price: 72.82, pe: 0, high52: 179.7, low52: 66.25, marketcap: 50816766843, ratio: 1.0992 },
                    { exchange: 'NYSE', ticker: 'LNC', name: 'LINCOLN NATIONAL CORP', price: 28.88, pe: 1.55, high52: 39.85, low52: 25.8, marketcap: 4929779093, ratio: 1.1194 },
                    { exchange: 'NYSE', ticker: 'FLR', name: 'FLUOR CORP', price: 31.45, pe: 2.5, high52: 60.1, low52: 29.2, marketcap: 5284210258, ratio: 1.0771 },
                    { exchange: 'NYSE', ticker: 'CIVI', name: 'CIVITAS RESOURCES INC', price: 25.89, pe: 3, high52: 78.63, low52: 22.79, marketcap: 2407286869, ratio: 1.1360 },
                    { exchange: 'NYSE', ticker: 'OGN', name: 'ORGANON', price: 11.4, pe: 3.41, high52: 23.1, low52: 11.05, marketcap: 2944500381, ratio: 1.0317 },
                    { exchange: 'NYSE', ticker: 'AES', name: 'AES CORP', price: 10.3, pe: 4.28, high52: 22.21, low52: 9.88, marketcap: 7304099292, ratio: 1.0425 },
                    { exchange: 'NYSE', ticker: 'RITM', name: 'RITHM CAPITAL CORP', price: 9.38, pe: 4.95, high52: 12.2, low52: 9.13, marketcap: 5107675000, ratio: 1.0274 },
                    { exchange: 'NYSE', ticker: 'SYF', name: 'SYNCHRONY FINANCIAL', price: 43.3, pe: 4.97, high52: 70.93, low52: 39.67, marketcap: 16832848723, ratio: 1.0915 },
                    { exchange: 'NYSE', ticker: 'MTDR', name: 'MATADOR RESOURCES', price: 36.31, pe: 5.02, high52: 71.08, low52: 35.19, marketcap: 4546273603, ratio: 1.0318 },
                    { exchange: 'NASDAQ', ticker: 'CHRD', name: 'CHORD ENERGY CORP', price: 84.2, pe: 5.17, high52: 190.23, low52: 79.83, marketcap: 4985217767, ratio: 1.0547 },
                    { exchange: 'NASDAQ', ticker: 'CROX', name: 'CROCS INC', price: 88.88, pe: 5.51, high52: 165.32, low52: 86.11, marketcap: 4976104247, ratio: 1.0322 },
                    { exchange: 'NYSE', ticker: 'JXN', name: 'JACKSON FINANCIAL INC CLASS A', price: 68.58, pe: 5.71, high52: 115.22, low52: 62.81, marketcap: 4971184278, ratio: 1.0919 },
                    { exchange: 'NYSE', ticker: 'MTH', name: 'MERITAGE CORP', price: 62.51, pe: 5.81, high52: 106.99, low52: 59.27, marketcap: 4473886216, ratio: 1.0547 },
                    { exchange: 'NASDAQ', ticker: 'WFRD', name: 'WEATHERFORD INTERNATIONAL PLC', price: 40, pe: 5.75, high52: 135, low52: 36.74, marketcap: 2882894752, ratio: 1.0887 },
                    { exchange: 'NYSE', ticker: 'DVN', name: 'DEVON ENERGY CORP', price: 26.96, pe: 5.83, high52: 55.09, low52: 25.89, marketcap: 17678759851, ratio: 1.0413 },
                    { exchange: 'NYSE', ticker: 'PVH', name: 'PVH CORP', price: 62.71, pe: 5.91, high52: 124.68, low52: 59.28, marketcap: 3300862459, ratio: 1.0579 },
                    { exchange: 'NYSE', ticker: 'F', name: 'FORD MOTOR', price: 8.74, pe: 5.9, high52: 14.85, low52: 8.44, marketcap: 34914081598, ratio: 1.0355 }
                ];
                
                // Add more blue-chip stocks to provide a comprehensive list
                const additionalStocks = [
                    { exchange: 'NYSE', ticker: 'JPM', name: 'JPMORGAN CHASE & CO', price: 198.46, pe: 12.1, high52: 203.87, low52: 135.19, marketcap: 571206000000, ratio: 1.4680 },
                    { exchange: 'NYSE', ticker: 'JNJ', name: 'JOHNSON & JOHNSON', price: 147.49, pe: 9.3, high52: 175.97, low52: 144.95, marketcap: 355016000000, ratio: 1.0175 },
                    { exchange: 'NYSE', ticker: 'PG', name: 'PROCTER & GAMBLE CO', price: 165.21, pe: 26.8, high52: 169.69, low52: 141.45, marketcap: 389600000000, ratio: 1.1680 },
                    { exchange: 'NYSE', ticker: 'V', name: 'VISA INC', price: 279.95, pe: 31.2, high52: 290.96, low52: 216.14, marketcap: 549800000000, ratio: 1.2952 },
                    { exchange: 'NYSE', ticker: 'HD', name: 'HOME DEPOT INC', price: 342.51, pe: 22.9, high52: 396.19, low52: 274.26, marketcap: 339762000000, ratio: 1.2488 },
                    { exchange: 'NYSE', ticker: 'PFE', name: 'PFIZER INC', price: 27.36, pe: 44.8, high52: 40.36, low52: 25.76, marketcap: 155185000000, ratio: 1.0621 },
                    { exchange: 'NYSE', ticker: 'BAC', name: 'BANK OF AMERICA CORP', price: 39.13, pe: 13.5, high52: 44.44, low52: 29.31, marketcap: 306824000000, ratio: 1.3351 },
                    { exchange: 'NYSE', ticker: 'KO', name: 'COCA-COLA CO', price: 61.12, pe: 25.7, high52: 64.25, low52: 55.01, marketcap: 263714000000, ratio: 1.1110 },
                    { exchange: 'NYSE', ticker: 'DIS', name: 'WALT DISNEY CO', price: 111.95, pe: 68.3, high52: 123.74, low52: 78.73, marketcap: 204804000000, ratio: 1.4220 },
                    { exchange: 'NASDAQ', ticker: 'AAPL', name: 'APPLE INC', price: 169.65, pe: 27.9, high52: 199.62, low52: 159.78, marketcap: 2621000000000, ratio: 1.0617 },
                    { exchange: 'NASDAQ', ticker: 'MSFT', name: 'MICROSOFT CORP', price: 417.24, pe: 35.7, high52: 430.82, low52: 274.37, marketcap: 3102000000000, ratio: 1.5208 },
                    { exchange: 'NASDAQ', ticker: 'AMZN', name: 'AMAZON.COM INC', price: 184.29, pe: 50.2, high52: 187.39, low52: 118.35, marketcap: 1906000000000, ratio: 1.5573 },
                    { exchange: 'NASDAQ', ticker: 'GOOG', name: 'ALPHABET INC CLASS C', price: 175.09, pe: 23.8, high52: 176.68, low52: 115.35, marketcap: 2158000000000, ratio: 1.5179 },
                    { exchange: 'NASDAQ', ticker: 'META', name: 'META PLATFORMS INC', price: 515.21, pe: 29.6, high52: 531.49, low52: 296.08, marketcap: 1306000000000, ratio: 1.7401 },
                    { exchange: 'NASDAQ', ticker: 'TSLA', name: 'TESLA INC', price: 166.63, pe: 46.9, high52: 299.29, low52: 152.37, marketcap: 531210000000, ratio: 1.0936 },
                    { exchange: 'NYSE', ticker: 'WMT', name: 'WALMART INC', price: 67.28, pe: 28.1, high52: 69.85, low52: 48.34, marketcap: 541620000000, ratio: 1.3918 },
                    { exchange: 'NYSE', ticker: 'XOM', name: 'EXXON MOBIL CORP', price: 107.35, pe: 12.7, high52: 120.70, low52: 95.77, marketcap: 424620000000, ratio: 1.1208 }
                ];
                
                return [...stockData, ...additionalStocks];
                }
                
                // Format the data
                allStocks = allStocks.map(stock => ({
                    ...stock,
                    price: parseFloat(stock.price || 0),
                    pe: parseFloat(stock.pe || 0),
                    high52: parseFloat(stock.high52 || 0),
                    low52: parseFloat(stock.low52 || 0),
                    marketcap: parseFloat(stock.marketcap || 0),
                    ratio: parseFloat(stock.ratio || 1)
                }));
                
                // Initialize filtered stocks with all stocks
                filteredStocks = [...allStocks];
                
                // Update stats
                updateStats();
                
                // Display data
                renderTable();
                renderPagination();
            } catch (error) {
                console.error('Error loading stock data:', error);
                alert('Error loading stock data. Please try again later.');
            } finally {
                showLoading(false);
            }
        }
        
        // Render the stock table
        function renderTable() {
            const tbody = document.getElementById('stocks-data');
            tbody.innerHTML = '';
            
            // Calculate pagination
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedStocks = filteredStocks.slice(start, end);
            
            if (paginatedStocks.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="9" style="text-align: center;">No stocks found. Try adjusting your filters.</td>';
                tbody.appendChild(tr);
                return;
            }
            
            // Create table rows
            paginatedStocks.forEach(stock => {
                const tr = document.createElement('tr');
                
                // Format market cap
                let formattedMarketCap;
                if (stock.marketcap >= 1e12) {
                    formattedMarketCap = `$${(stock.marketcap / 1e12).toFixed(2)}T`;
                } else if (stock.marketcap >= 1e9) {
                    formattedMarketCap = `$${(stock.marketcap / 1e9).toFixed(2)}B`;
                } else if (stock.marketcap >= 1e6) {
                    formattedMarketCap = `$${(stock.marketcap / 1e6).toFixed(2)}M`;
                } else {
                    formattedMarketCap = `$${stock.marketcap.toLocaleString()}`;
                }
                
                // Determine ratio class
                const ratioClass = stock.ratio < 1.1 ? 'good' : '';
                
                tr.innerHTML = `
                    <td><span class="exchange ${stock.exchange.toLowerCase()}">${stock.exchange}</span></td>
                    <td class="ticker">${stock.ticker}</td>
                    <td>${stock.name}</td>
                    <td class="price">${stock.price.toFixed(2)}</td>
                    <td class="pe">${stock.pe.toFixed(2)}</td>
                    <td class="high">${stock.high52.toFixed(2)}</td>
                    <td class="low">${stock.low52.toFixed(2)}</td>
                    <td class="cap">${formattedMarketCap}</td>
                    <td class="ratio ${ratioClass}">${(stock.ratio * 100).toFixed(2)}%</td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        // Render pagination controls
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            const pageCount = Math.ceil(filteredStocks.length / rowsPerPage);
            
            if (pageCount <= 1) {
                return;
            }
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    renderPagination();
                }
            });
            pagination.appendChild(prevButton);
            
            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(pageCount, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPage);
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    renderTable();
                    renderPagination();
                });
                pagination.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPage === pageCount;
            nextButton.addEventListener('click', () => {
                if (currentPage < pageCount) {
                    currentPage++;
                    renderTable();
                    renderPagination();
                }
            });
            pagination.appendChild(nextButton);
        }
        
        // Apply filters to the stock data
        function applyFilters() {
            const exchange = document.getElementById('exchange').value;
            const minPE = parseFloat(document.getElementById('min-pe').value) || 0;
            const maxPE = parseFloat(document.getElementById('max-pe').value) || Infinity;
            const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
            const search = document.getElementById('search').value.toLowerCase();
            
            filteredStocks = allStocks.filter(stock => {
                // Exchange filter
                if (exchange !== 'all' && stock.exchange !== exchange) {
                    return false;
                }
                
                // PE filter
                if (stock.pe < minPE || stock.pe > maxPE) {
                    return false;
                }
                
                // Price filter
                if (stock.price < minPrice || stock.price > maxPrice) {
                    return false;
                }
                
                // Search filter
                if (search && !stock.ticker.toLowerCase().includes(search) && !stock.name.toLowerCase().includes(search)) {
                    return false;
                }
                
                return true;
            });
            
            // Reset to first page
            currentPage = 1;
            
            // Update stats
            updateStats();
            
            // Render table and pagination
            renderTable();
            renderPagination();
        }
        
        // Quick search (triggered on input)
        function quickSearch() {
            const search = document.getElementById('search').value.toLowerCase();
            
            if (search) {
                filteredStocks = allStocks.filter(stock => 
                    stock.ticker.toLowerCase().includes(search) || 
                    stock.name.toLowerCase().includes(search)
                );
            } else {
                // If search is empty, apply other filters
                applyFilters();
                return;
            }
            
            // Reset to first page
            currentPage = 1;
            
            // Update stats
            updateStats();
            
            // Render table and pagination
            renderTable();
            renderPagination();
        }
        
        // Reset all filters
        function resetFilters() {
            document.getElementById('exchange').value = 'all';
            document.getElementById('min-pe').value = '';
            document.getElementById('max-pe').value = '';
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            document.getElementById('search').value = '';
            
            // Reset filtered stocks to all stocks
            filteredStocks = [...allStocks];
            
            // Reset to first page
            currentPage = 1;
            
            // Update stats
            updateStats();
            
            // Render table and pagination
            renderTable();
            renderPagination();
        }
        
        // Sort data by column
        function sortData(column) {
            // Toggle sort direction if clicking the same column
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update sort icons
            document.querySelectorAll('th[data-sort] i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const sortIcon = document.querySelector(`th[data-sort="${column}"] i`);
            sortIcon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'}`;
            
            // Sort the data
            filteredStocks.sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];
                
                // Handle string comparisons
                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }
                
                // Compare values
                if (aValue < bValue) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            // Render table
            renderTable();
        }
        
        // Update statistics
        function updateStats() {
            // Calculate statistics
            const totalStocks = filteredStocks.length;
            
            let totalPE = 0;
            let totalRatio = 0;
            let totalMarketCap = 0;
            
            filteredStocks.forEach(stock => {
                if (stock.pe > 0) {
                    totalPE += stock.pe;
                }
                totalRatio += stock.ratio;
                totalMarketCap += stock.marketcap;
            });
            
            const avgPE = totalStocks > 0 ? totalPE / totalStocks : 0;
            const avgRatio = totalStocks > 0 ? totalRatio / totalStocks : 0;
            
            // Format market cap
            let formattedMarketCap;
            if (totalMarketCap >= 1e12) {
                formattedMarketCap = `${(totalMarketCap / 1e12).toFixed(2)}T`;
            } else if (totalMarketCap >= 1e9) {
                formattedMarketCap = `${(totalMarketCap / 1e9).toFixed(2)}B`;
            } else if (totalMarketCap >= 1e6) {
                formattedMarketCap = `${(totalMarketCap / 1e6).toFixed(2)}M`;
            } else {
                formattedMarketCap = `${totalMarketCap.toLocaleString()}`;
            }
            
            // Update DOM
            document.getElementById('totalStocks').textContent = totalStocks;
            document.getElementById('avgPE').textContent = avgPE.toFixed(2);
            document.getElementById('avgRatio').textContent = `${(avgRatio * 100).toFixed(2)}%`;
            document.getElementById('totalMarketCap').textContent = formattedMarketCap;
        }
        
        // Show/hide loading indicator
        function showLoading(show) {
            const loading = document.querySelector('.loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }
        
        // Fetch data from Google Sheets using a better approach
        async function fetchGoogleSheetsData() {
            try {
                // Option 1: Use Google Sheets API as JSON
                const apiKey = 'YOUR_API_KEY'; // You need to get a Google API key for this method
                
                // Note: This approach requires setting up Google Sheets API and a key
                // For most cases, we'll use the fallback data instead
                
                // If you want to implement this in the future:
                // 1. Get an API key from Google Cloud Console (enable Sheets API)
                // 2. Replace YOUR_API_KEY above with your actual key
                // 3. Uncomment the code below
                
                /*
                const sheetId = 'YOUR_ACTUAL_SHEET_ID'; // Not the published ID, but the sheet ID from URL
                const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${SHEET_NAME}?key=${apiKey}`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch data from Google Sheets API');
                }
                
                const data = await response.json();
                
                // Process the data
                const headers = data.values[0].map(h => h.toLowerCase());
                const rows = data.values.slice(1);
                
                return rows.map(row => {
                    const stock = {};
                    headers.forEach((header, index) => {
                        stock[header] = row[index] || '';
                    });
                    return stock;
                });
                */
                
                // For now, just throw an error to use the fallback data
                throw new Error('Using fallback data instead of API');
            } catch (error) {
                console.warn('Using fallback data:', error);
                throw error;
            }
        }
        
        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(header => header.trim().toLowerCase().replace(/"/g, ''));
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].split(',');
                if (line.length === headers.length) {
                    const stock = {};
                    headers.forEach((header, index) => {
                        let value = line[index].replace(/"/g, '').trim();
                        
                        // Convert numeric values
                        if (['price', 'pe', 'high52', 'low52', 'marketcap', 'ratio'].includes(header)) {
                            value = parseFloat(value) || 0;
                        }
                        
                        stock[header] = value;
                    });
                    data.push(stock);
                }
            }
            
            return data;
        }
    </script>
</body>
</html>